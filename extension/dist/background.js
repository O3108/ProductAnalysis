(()=>{"use strict";function e(e){let n=e.replace(/```json\s*/gi,"").replace(/```\s*/g,"").trim();const t=n.indexOf("{");if(t>0&&(n=n.slice(t)),!n.endsWith("}")){const e=n.lastIndexOf("}");if(e>0){n=n.slice(0,e+1);const t=(n.match(/\[/g)||[]).length,r=(n.match(/\]/g)||[]).length,s=(n.match(/\{/g)||[]).length,o=(n.match(/\}/g)||[]).length;t>r&&(n+="]"),s>o&&(n+="}")}}return n}async function n(n,t){const r=function(e){const n=e.filter(e=>e.price>0),t=function(e){const n=[...e].sort((e,n)=>e-n),t=Math.floor(n.length/2);return n.length%2!=0?n[t]:(n[t-1]+n[t])/2}(n.map(e=>e.price)),r=new Map;for(const e of n){const n=(e.manufacturer||"Неизвестно").trim().toLowerCase();r.has(n)||r.set(n,[]),r.get(n).push(e)}const s=[];for(const[,e]of r){const n=e.reduce((e,n)=>Math.abs(n.price-t)<Math.abs(e.price-t)?n:e);s.push(n)}return s.slice(0,10)}(n),s=r.map((e,n)=>{const t=[`${n+1}. Производитель: ${e.manufacturer||"Неизвестно"}`];return e.partNumber&&t.push(`Артикул: ${e.partNumber}`),e.description&&t.push(`Деталь: ${e.description}`),e.volume&&t.push(`Объём: ${e.volume} л`),t.push("Цена: "+(e.price>0?e.price+" ₽":"нет данных")),e.pricePerLiter&&t.push(`Цена за литр: ${Math.round(e.pricePerLiter)} ₽/л`),e.supplier&&t.push(`Поставщик: ${e.supplier}`),e.deliveryDate&&t.push(`Дата доставки: ${e.deliveryDate}`),t.join(", ")}).join("\n"),o=`Список предложений для анализа (${r.length} шт.):\n${s}\n\nПроанализируй по критерию цена/качество и верни JSON.`,c=await fetch("https://api.deepseek.com/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"system",content:'Ты эксперт по анализу автозапчастей. Тебе дадут список предложений одной и той же детали от разных поставщиков с сайта exist.ru.\n\nСтруктура каждого предложения:\n- Производитель (бренд детали) — например "Geely", "Bosch", "LUK"\n- Артикул — номер детали\n- Поставщик — продавец на exist.ru (не производитель)\n- Цена в рублях\n- Дата доставки — когда деталь будет доступна\n\nКритерии оценки (по убыванию важности):\n1. Производитель — оригинал (совпадает с маркой авто или известный OEM) > известный бренд запчастей > неизвестный\n2. Цена — для жидкостей сравнивай по "Цена за литр" (₽/л), а не по общей цене. Для остальных товаров — по общей цене. Чем ниже относительно среднего по списку, тем лучше\n3. Дата доставки — чем раньше, тем лучше\n\nПравила:\n- Оригинальная деталь по средней цене лучше дешёвого аналога\n- Если цена не указана — score не выше 4\n- Не придумывай характеристики детали — оценивай только по данным из списка\n\nОЦЕНКА РИСКА ПОДДЕЛКИ (counterfeitRisk):\nДля каждого товара оцени риск подделки на основе следующих факторов:\n1. Популярность бренда — известные бренды (Bosch, Castrol, Mobil, Shell, Total, ZIC) и ОРИГИНАЛЬНЫЕ запчасти подделывают чаще всего\n2. Цена относительно других предложений:\n   - ВАЖНО: Оригинальные запчасти обычно стоят КАК известные бренды (Bosch, Castrol и т.д.) или ДОРОЖЕ\n   - Если ОРИГИНАЛ стоит значительно дешевле известных брендов (>20%) — это ВЫСОКИЙ риск подделки\n   - Если известный бренд стоит значительно дешевле среднего по известным брендам (>30%) — ВЫСОКИЙ риск\n   - Оригинал дешевле неизвестных китайских брендов — ОЧЕНЬ подозрительно\n3. Тип товара — моторные масла, фильтры, тормозные колодки, свечи подделывают чаще всего\n\nУровни риска:\n- "high" — оригинал дешевле известных брендов, известный бренд по подозрительно низкой цене, премиум масла по низкой цене\n- "medium" — популярный бренд по средней цене, оригинал по цене известных брендов (нормально)\n- "low" — малоизвестный бренд, товары которые редко подделывают\n\nВАЖНО: Оригинальные запчасти подделывают чаще всего! Если оригинал стоит дешевле Bosch/Castrol — это почти наверняка подделка.\n\nВ поле counterfeitReason кратко объясни почему такой уровень риска (1 предложение).\n\nОтвечай СТРОГО в формате JSON (без markdown блоков):\n{\n  "results": [\n    {\n      "rank": 1,\n      "name": "Производитель Артикул",\n      "brand": "производитель",\n      "price": 1234,\n      "score": 8.5,\n      "verdict": "Оригинальная деталь по лучшей цене",\n      "pros": ["плюс 1", "плюс 2"],\n      "cons": ["минус 1"],\n      "recommendation": "Рекомендуется",\n      "counterfeitRisk": "low",\n      "counterfeitReason": "Оригинальная запчасть по рыночной цене"\n    }\n  ],\n  "summary": "Краткий итог: диапазон цен, лучший производитель и предложение",\n  "bestChoice": "Производитель Артикул у поставщика"\n}\n\nОценка score от 1 до 10. Сортируй результаты по убыванию score.'},{role:"user",content:o}],max_tokens:4096,temperature:.3})});if(!c.ok){const e=await c.text();throw new Error(`DeepSeek API error ${c.status}: ${e}`)}const i=await c.json(),a=(p=i.choices?.[0]?.message?.content,"string"==typeof p?p.trim():Array.isArray(p)?p.map(e=>"string"==typeof e?e:e&&"object"==typeof e&&"text"in e&&"string"==typeof e.text?e.text:"").filter(Boolean).join("\n").trim():p&&"object"==typeof p&&"text"in p&&"string"==typeof p.text?p.text:String(p??"").trim());var p;const u=e(a);try{return JSON.parse(u)}catch(n){const t=a.match(/\{[\s\S]*"results"[\s\S]*\}/);if(t){const n=e(t[0]);try{return JSON.parse(n)}catch{}}throw new Error("Не удалось распарсить ответ модели. Позиция ошибки может указывать на обрезанный JSON — попробуйте снова.")}}chrome.runtime.onMessage.addListener((e,t,r)=>{if("ANALYZE_PRODUCTS"===e.type){const{products:t,apiKey:s}=e;return n(t,s).then(e=>r({success:!0,data:e})).catch(e=>r({success:!1,error:e.message})),!0}})})();