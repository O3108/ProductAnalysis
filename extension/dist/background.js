(()=>{"use strict";function e(e){let t=e.replace(/```json\s*/gi,"").replace(/```\s*/g,"").trim();const n=t.indexOf("{");if(n>0&&(t=t.slice(n)),!t.endsWith("}")){const e=t.lastIndexOf("}");if(e>0){t=t.slice(0,e+1);const n=(t.match(/\[/g)||[]).length,r=(t.match(/\]/g)||[]).length,s=(t.match(/\{/g)||[]).length,o=(t.match(/\}/g)||[]).length;n>r&&(t+="]"),s>o&&(t+="}")}}return t}chrome.runtime.onMessage.addListener((t,n,r)=>{if("ANALYZE_PRODUCTS"===t.type){const{products:n,apiKey:s}=t;return async function(t,n){const r=function(e){return e.length<=20?e:[...e.filter(e=>e.price>0).sort((e,t)=>e.price-t.price),...e.filter(e=>e.price<=0)].slice(0,20)}(t),s=r.map((e,t)=>{const n=[`${t+1}. Производитель: ${e.manufacturer||"Неизвестно"}`];return e.partNumber&&n.push(`Артикул: ${e.partNumber}`),e.description&&n.push(`Деталь: ${e.description}`),n.push("Цена: "+(e.price>0?e.price+" ₽":"нет данных")),e.supplier&&n.push(`Поставщик: ${e.supplier}`),e.deliveryDate&&n.push(`Дата доставки: ${e.deliveryDate}`),n.join(", ")}).join("\n"),o=`Список предложений для анализа (${r.length} шт.):\n${s}\n\nПроанализируй по критерию цена/качество и верни JSON.`,c=await fetch("https://api.deepseek.com/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"system",content:'Ты эксперт по анализу автозапчастей. Тебе дадут список предложений одной и той же детали от разных поставщиков с сайта exist.ru.\n\nСтруктура каждого предложения:\n- Производитель (бренд детали) — например "Geely", "Bosch", "LUK"\n- Артикул — номер детали\n- Поставщик — продавец на exist.ru (не производитель)\n- Цена в рублях\n- Дата доставки — когда деталь будет доступна\n\nКритерии оценки (по убыванию важности):\n1. Производитель — оригинал (совпадает с маркой авто или известный OEM) > известный бренд запчастей > неизвестный\n2. Цена — чем ниже относительно среднего по списку, тем лучше\n3. Дата доставки — чем раньше, тем лучше\n\nПравила:\n- Оригинальная деталь по средней цене лучше дешёвого аналога\n- Если цена не указана — score не выше 4\n- Не придумывай характеристики детали — оценивай только по данным из списка\n\nОтвечай СТРОГО в формате JSON (без markdown блоков):\n{\n  "results": [\n    {\n      "rank": 1,\n      "name": "Производитель Артикул",\n      "brand": "производитель",\n      "price": 1234,\n      "score": 8.5,\n      "verdict": "Оригинальная деталь по лучшей цене",\n      "pros": ["плюс 1", "плюс 2"],\n      "cons": ["минус 1"],\n      "recommendation": "Рекомендуется"\n    }\n  ],\n  "summary": "Краткий итог: диапазон цен, лучший производитель и предложение",\n  "bestChoice": "Производитель Артикул у поставщика"\n}\n\nОценка score от 1 до 10. Сортируй результаты по убыванию score.'},{role:"user",content:o}],max_tokens:4096,temperature:.3})});if(!c.ok){const e=await c.text();throw new Error(`DeepSeek API error ${c.status}: ${e}`)}const i=await c.json(),a=(p=i.choices?.[0]?.message?.content,"string"==typeof p?p.trim():Array.isArray(p)?p.map(e=>"string"==typeof e?e:e&&"object"==typeof e&&"text"in e&&"string"==typeof e.text?e.text:"").filter(Boolean).join("\n").trim():p&&"object"==typeof p&&"text"in p&&"string"==typeof p.text?p.text:String(p??"").trim());var p;const h=e(a);try{return JSON.parse(h)}catch(t){const n=a.match(/\{[\s\S]*"results"[\s\S]*\}/);if(n){const t=e(n[0]);try{return JSON.parse(t)}catch{}}throw new Error("Не удалось распарсить ответ модели. Позиция ошибки может указывать на обрезанный JSON — попробуйте снова.")}}(n,s).then(e=>r({success:!0,data:e})).catch(e=>r({success:!1,error:e.message})),!0}})})();