(()=>{"use strict";function e(e){const t=[...e].sort((e,t)=>e-t),n=Math.floor(t.length/2);return t.length%2!=0?t[n]:(t[n-1]+t[n])/2}function t(e){let t=e.replace(/```json\s*/gi,"").replace(/```\s*/g,"").trim();const n=t.indexOf("{");if(n>0&&(t=t.slice(n)),!t.endsWith("}")){const e=t.lastIndexOf("}");if(e>0){t=t.slice(0,e+1);const n=(t.match(/\[/g)||[]).length,r=(t.match(/\]/g)||[]).length,s=(t.match(/\{/g)||[]).length,o=(t.match(/\}/g)||[]).length;n>r&&(t+="]"),s>o&&(t+="}")}}return t}chrome.runtime.onMessage.addListener((n,r,s)=>{if("ANALYZE_PRODUCTS"===n.type){const{products:r,apiKey:o}=n;return async function(n,r){const s=function(t){const n=t.filter(e=>e.price>0),r=new Map;for(const e of n){const t=(e.manufacturer||"Неизвестно").trim().toLowerCase();r.has(t)||r.set(t,[]),r.get(t).push(e)}const s=[];for(const[,t]of r){const n=e(t.map(e=>e.price)),r=t.reduce((e,t)=>Math.abs(t.price-n)<Math.abs(e.price-n)?t:e);s.push(r)}return s.slice(0,10)}(n),o=s.map((e,t)=>{const n=[`${t+1}. Производитель: ${e.manufacturer||"Неизвестно"}`];return e.partNumber&&n.push(`Артикул: ${e.partNumber}`),e.description&&n.push(`Деталь: ${e.description}`),e.volume&&n.push(`Объём: ${e.volume} л`),n.push("Цена: "+(e.price>0?e.price+" ₽":"нет данных")),e.pricePerLiter&&n.push(`Цена за литр: ${Math.round(e.pricePerLiter)} ₽/л`),e.supplier&&n.push(`Поставщик: ${e.supplier}`),e.deliveryDate&&n.push(`Дата доставки: ${e.deliveryDate}`),n.join(", ")}).join("\n"),c=`Список предложений для анализа (${s.length} шт.):\n${o}\n\nПроанализируй по критерию цена/качество и верни JSON.`,i=await fetch("https://api.deepseek.com/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"system",content:'Ты эксперт по анализу автозапчастей. Тебе дадут список предложений одной и той же детали от разных поставщиков с сайта exist.ru.\n\nСтруктура каждого предложения:\n- Производитель (бренд детали) — например "Geely", "Bosch", "LUK"\n- Артикул — номер детали\n- Поставщик — продавец на exist.ru (не производитель)\n- Цена в рублях\n- Дата доставки — когда деталь будет доступна\n\nКритерии оценки (по убыванию важности):\n1. Производитель — оригинал (совпадает с маркой авто или известный OEM) > известный бренд запчастей > неизвестный\n2. Цена — для жидкостей сравнивай по "Цена за литр" (₽/л), а не по общей цене. Для остальных товаров — по общей цене. Чем ниже относительно среднего по списку, тем лучше\n3. Дата доставки — чем раньше, тем лучше\n\nПравила:\n- Оригинальная деталь по средней цене лучше дешёвого аналога\n- Если цена не указана — score не выше 4\n- Не придумывай характеристики детали — оценивай только по данным из списка\n\nОЦЕНКА РИСКА ПОДДЕЛКИ (counterfeitRisk):\nДля каждого товара оцени риск подделки на основе следующих факторов:\n1. Популярность бренда — известные бренды (Bosch, Castrol, Mobil, Shell, Total, ZIC, оригинальные запчасти) подделывают чаще\n2. Цена — если известный бренд стоит значительно дешевле среднего (>30%) — высокий риск подделки\n3. Тип товара — моторные масла, фильтры, тормозные колодки подделывают чаще всего\n\nУровни риска:\n- "high" — известный бренд по подозрительно низкой цене, или самые подделываемые категории (масла премиум-брендов)\n- "medium" — популярный бренд по средней цене, или менее известный бренд по низкой цене\n- "low" — малоизвестный бренд, оригинальные запчасти по адекватной цене, или товары которые редко подделывают\n\nВ поле counterfeitReason кратко объясни почему такой уровень риска (1 предложение).\n\nОтвечай СТРОГО в формате JSON (без markdown блоков):\n{\n  "results": [\n    {\n      "rank": 1,\n      "name": "Производитель Артикул",\n      "brand": "производитель",\n      "price": 1234,\n      "score": 8.5,\n      "verdict": "Оригинальная деталь по лучшей цене",\n      "pros": ["плюс 1", "плюс 2"],\n      "cons": ["минус 1"],\n      "recommendation": "Рекомендуется",\n      "counterfeitRisk": "low",\n      "counterfeitReason": "Оригинальная запчасть по рыночной цене"\n    }\n  ],\n  "summary": "Краткий итог: диапазон цен, лучший производитель и предложение",\n  "bestChoice": "Производитель Артикул у поставщика"\n}\n\nОценка score от 1 до 10. Сортируй результаты по убыванию score.'},{role:"user",content:c}],max_tokens:4096,temperature:.3})});if(!i.ok){const e=await i.text();throw new Error(`DeepSeek API error ${i.status}: ${e}`)}const a=await i.json(),p=(u=a.choices?.[0]?.message?.content,"string"==typeof u?u.trim():Array.isArray(u)?u.map(e=>"string"==typeof e?e:e&&"object"==typeof e&&"text"in e&&"string"==typeof e.text?e.text:"").filter(Boolean).join("\n").trim():u&&"object"==typeof u&&"text"in u&&"string"==typeof u.text?u.text:String(u??"").trim());var u;const h=t(p);try{return JSON.parse(h)}catch(e){const n=p.match(/\{[\s\S]*"results"[\s\S]*\}/);if(n){const e=t(n[0]);try{return JSON.parse(e)}catch{}}throw new Error("Не удалось распарсить ответ модели. Позиция ошибки может указывать на обрезанный JSON — попробуйте снова.")}}(r,o).then(e=>s({success:!0,data:e})).catch(e=>s({success:!1,error:e.message})),!0}})})();