(()=>{"use strict";let e=[],n=null,t=null;const i=e=>document.getElementById(e);function s(){return new Promise(e=>{chrome.storage.local.get(["apiKey"],n=>{e(n.apiKey||"")})})}function r(){if(!t)return;const e=(new Date).toLocaleString("ru-RU"),n=t.results.map(e=>{const n=e.pros.length>0?`<div class="result-section">\n             <div class="result-section-title">–ü–ª—é—Å—ã:</div>\n             <ul class="result-list">\n               ${e.pros.map(e=>`<li>${d(e)}</li>`).join("")}\n             </ul>\n           </div>`:"",t=e.cons.length>0?`<div class="result-section">\n             <div class="result-section-title">–ú–∏–Ω—É—Å—ã:</div>\n             <ul class="result-list">\n               ${e.cons.map(e=>`<li>${d(e)}</li>`).join("")}\n             </ul>\n           </div>`:"",i=e.counterfeitRisk?`<div class="result-counterfeit" style="background: ${{low:"#065f46",medium:"#713f12",high:"#7f1d1d"}[e.counterfeitRisk]}; border: 1px solid ${{low:"#10b981",medium:"#f59e0b",high:"#ef4444"}[e.counterfeitRisk]}">\n             <div class="result-counterfeit-label" style="color: ${{low:"#6ee7b7",medium:"#fcd34d",high:"#fca5a5"}[e.counterfeitRisk]}">${{low:"–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ –ø–æ–¥–¥–µ–ª–∫–∏",medium:"–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ –ø–æ–¥–¥–µ–ª–∫–∏",high:"–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –ø–æ–¥–¥–µ–ª–∫–∏"}[e.counterfeitRisk]}</div>\n             ${e.counterfeitReason?`<div class="result-counterfeit-reason">${d(e.counterfeitReason)}</div>`:""}\n           </div>`:"";return`\n        <div class="result-card">\n          <div class="result-header">\n            <div class="result-name">${d(e.name)}</div>\n            <div class="result-score score-${Math.floor(e.score)}">${e.score}/10</div>\n          </div>\n          <div class="result-brand">${d(e.brand)}</div>\n          <div class="result-price">${e.price>0?e.price.toLocaleString("ru-RU")+" ‚ÇΩ":"–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}</div>\n          <div class="result-verdict">${d(e.verdict)}</div>\n          ${i}\n          ${n}\n          ${t}\n          <div class="result-recommendation">\n            <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> ${d(e.recommendation)}\n          </div>\n        </div>\n      `}).join(""),i=`<!DOCTYPE html>\n<html lang="ru">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>–ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–æ–≤ exist.ru - ${e}</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body {\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      background: #0f172a;\n      color: #e2e8f0;\n      padding: 20px;\n      line-height: 1.6;\n    }\n    .container { max-width: 800px; margin: 0 auto; }\n    .header {\n      background: #1e293b;\n      padding: 24px;\n      border-radius: 12px;\n      margin-bottom: 24px;\n      border: 1px solid #334155;\n    }\n    .title { font-size: 24px; font-weight: 700; margin-bottom: 12px; color: #60a5fa; }\n    .date { font-size: 14px; color: #94a3b8; margin-bottom: 20px; }\n    .summary-section {\n      background: #1e293b;\n      padding: 20px;\n      border-radius: 8px;\n      margin-bottom: 16px;\n      border: 1px solid #334155;\n    }\n    .summary-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #60a5fa; }\n    .summary-text { font-size: 14px; color: #cbd5e1; line-height: 1.7; }\n    .best-choice {\n      background: #065f46;\n      padding: 16px;\n      border-radius: 8px;\n      margin-bottom: 24px;\n      border: 1px solid #10b981;\n    }\n    .best-choice-label { font-size: 12px; color: #6ee7b7; text-transform: uppercase; margin-bottom: 4px; }\n    .best-choice-text { font-size: 16px; font-weight: 600; color: #d1fae5; }\n    .results-title {\n      font-size: 20px;\n      font-weight: 600;\n      margin-bottom: 16px;\n      color: #e2e8f0;\n    }\n    .result-card {\n      background: #1e293b;\n      border: 1px solid #334155;\n      border-radius: 8px;\n      padding: 16px;\n      margin-bottom: 12px;\n    }\n    .result-header {\n      display: flex;\n      justify-content: space-between;\n      align-items: flex-start;\n      margin-bottom: 8px;\n    }\n    .result-name { font-size: 15px; font-weight: 600; color: #e2e8f0; flex: 1; }\n    .result-score {\n      background: #334155;\n      padding: 4px 10px;\n      border-radius: 12px;\n      font-size: 13px;\n      font-weight: 600;\n      margin-left: 12px;\n    }\n    .score-9, .score-10 { background: #065f46; color: #6ee7b7; }\n    .score-7, .score-8 { background: #1e40af; color: #93c5fd; }\n    .score-5, .score-6 { background: #713f12; color: #fcd34d; }\n    .score-0, .score-1, .score-2, .score-3, .score-4 { background: #7f1d1d; color: #fca5a5; }\n    .result-brand { font-size: 13px; color: #94a3b8; margin-bottom: 4px; }\n    .result-price {\n      font-size: 16px;\n      font-weight: 600;\n      color: #60a5fa;\n      margin-bottom: 12px;\n    }\n    .result-verdict {\n      font-size: 14px;\n      color: #cbd5e1;\n      margin-bottom: 12px;\n      padding: 12px;\n      background: #0f172a;\n      border-radius: 6px;\n    }\n    .result-counterfeit {\n      padding: 12px;\n      border-radius: 6px;\n      margin-bottom: 12px;\n    }\n    .result-counterfeit-label {\n      font-size: 12px;\n      font-weight: 600;\n      text-transform: uppercase;\n      letter-spacing: 0.05em;\n      margin-bottom: 4px;\n    }\n    .result-counterfeit-reason {\n      font-size: 12px;\n      color: #cbd5e1;\n      line-height: 1.5;\n    }\n    .result-section { margin-bottom: 12px; }\n    .result-section-title {\n      font-size: 12px;\n      font-weight: 600;\n      color: #94a3b8;\n      text-transform: uppercase;\n      margin-bottom: 6px;\n    }\n    .result-list {\n      list-style: none;\n      padding-left: 0;\n    }\n    .result-list li {\n      font-size: 13px;\n      color: #cbd5e1;\n      padding: 4px 0;\n      padding-left: 16px;\n      position: relative;\n    }\n    .result-list li:before {\n      content: "‚Ä¢";\n      position: absolute;\n      left: 0;\n      color: #60a5fa;\n    }\n    .result-recommendation {\n      font-size: 13px;\n      color: #cbd5e1;\n      padding-top: 12px;\n      border-top: 1px solid #334155;\n    }\n    .footer {\n      text-align: center;\n      padding: 20px;\n      color: #64748b;\n      font-size: 12px;\n    }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <div class="header">\n      <div class="title">–ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–æ–≤ exist.ru</div>\n      <div class="date">${d(e)}</div>\n    </div>\n\n    <div class="summary-section">\n      <div class="summary-title">–ò—Ç–æ–≥–∏ –∞–Ω–∞–ª–∏–∑–∞</div>\n      <div class="summary-text">${d(t.summary)}</div>\n    </div>\n\n    <div class="best-choice">\n      <div class="best-choice-label">–õ—É—á—à–∏–π –≤—ã–±–æ—Ä</div>\n      <div class="best-choice-text">${d(t.bestChoice)}</div>\n    </div>\n\n    <div class="results-title">–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</div>\n    ${n}\n\n    <div class="footer">\n      –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ Product Analyzer –¥–ª—è exist.ru\n    </div>\n  </div>\n</body>\n</html>`,s=new Blob([i],{type:"text/html;charset=utf-8"}),r=URL.createObjectURL(s),o=document.createElement("a");o.href=r,o.download=`exist-analysis-${(new Date).toISOString().slice(0,10)}.html`,o.click(),URL.revokeObjectURL(r)}function o(e){["screen-main","screen-settings","screen-results","screen-loading","screen-error","screen-history"].forEach(e=>{const n=document.getElementById(e);n&&(n.style.display="none")});const n=document.getElementById(`screen-${e}`);n&&(n.style.display="flex")}async function a(){const n=await new Promise(e=>{chrome.storage.local.get(["analysisHistory"],n=>{e(n.analysisHistory||[])})}),s=i("history-list"),r=i("history-empty");0===n.length?(s.innerHTML="",r.style.display="flex"):(r.style.display="none",s.innerHTML=n.map(e=>{const n=new Date(e.timestamp).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});return`\n          <div class="history-item" data-id="${e.id}">\n            <div class="history-item-content">\n              <div class="history-item-header">\n                <div class="history-item-title">${d(e.pageTitle)}</div>\n                <div class="history-item-date">${n}</div>\n              </div>\n              <div class="history-item-summary">${d(e.result.summary)}</div>\n            </div>\n            <button class="history-item-delete" data-id="${e.id}" title="–£–¥–∞–ª–∏—Ç—å">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n              </svg>\n            </button>\n          </div>\n        `}).join(""),s.querySelectorAll(".history-item-content").forEach(i=>{i.addEventListener("click",()=>{const s=i.parentElement?.getAttribute("data-id"),r=n.find(e=>e.id===s);r&&(t=r.result,e=r.products,l(r.result),o("results"))})}),s.querySelectorAll(".history-item-delete").forEach(e=>{e.addEventListener("click",async n=>{n.stopPropagation();const t=e.getAttribute("data-id");t&&confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?")&&(await function(e){return new Promise(n=>{chrome.storage.local.get(["analysisHistory"],t=>{const i=(t.analysisHistory||[]).filter(n=>n.id!==e);chrome.storage.local.set({analysisHistory:i},n)})})}(t),await a())})})),o("history")}function c(e,n="info"){const t=i("status-text");t.textContent=e,t.className=`status-text status-${n}`}function l(e){const n=i("results-list");n.innerHTML="",i("results-summary").innerHTML=`\n    <div class="summary-box">\n      <div class="summary-label">–õ—É—á—à–∏–π –≤—ã–±–æ—Ä</div>\n      <div class="summary-best">${d(e.bestChoice)}</div>\n      <div class="summary-text">${d(e.summary)}</div>\n    </div>\n  `,e.results.forEach(e=>{const t=document.createElement("div");t.className=`product-card rank-${e.rank<=3?e.rank:"other"}`;const i=e.score>=8?"#22c55e":e.score>=6?"#f59e0b":"#ef4444",s=1===e.rank?"ü•á":2===e.rank?"ü•à":3===e.rank?"ü•â":`#${e.rank}`,r=e.pros.map(e=>`<li class="pro">‚úì ${d(e)}</li>`).join(""),o=e.cons.map(e=>`<li class="con">‚úó ${d(e)}</li>`).join(""),a={low:"#22c55e",medium:"#f59e0b",high:"#ef4444"};t.innerHTML=`\n      <div class="card-header">\n        <div class="card-rank">${s}</div>\n        <div class="card-info">\n          <div class="card-brand">${d(e.brand||e.name)}</div>\n          <div class="card-price">${e.price>0?e.price.toLocaleString("ru-RU")+" ‚ÇΩ":"–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}</div>\n        </div>\n        <div class="card-score" style="color: ${i}">\n          <span class="score-value">${e.score.toFixed(1)}</span>\n          <span class="score-label">/10</span>\n        </div>\n      </div>\n      <div class="card-verdict">${d(e.verdict)}</div>\n      ${e.counterfeitRisk?`\n        <div class="card-counterfeit risk-${e.counterfeitRisk}" style="border-color: ${a[e.counterfeitRisk]}">\n          <span class="counterfeit-icon" style="color: ${a[e.counterfeitRisk]}">${{low:"‚úì",medium:"‚ö†",high:"‚ö†"}[e.counterfeitRisk]}</span>\n          <div class="counterfeit-info">\n            <div class="counterfeit-label" style="color: ${a[e.counterfeitRisk]}">${{low:"–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ –ø–æ–¥–¥–µ–ª–∫–∏",medium:"–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ –ø–æ–¥–¥–µ–ª–∫–∏",high:"–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –ø–æ–¥–¥–µ–ª–∫–∏"}[e.counterfeitRisk]}</div>\n            ${e.counterfeitReason?`<div class="counterfeit-reason">${d(e.counterfeitReason)}</div>`:""}\n          </div>\n        </div>\n      `:""}\n      <ul class="card-list">\n        ${r}\n        ${o}\n      </ul>\n      <div class="card-recommendation">${d(e.recommendation)}</div>\n    `,n.appendChild(t)})}function d(e){return(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}async function u(){const e=await async function(){return new Promise(e=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>{e(n[0]||null)})})}();return e&&e.url?(n=e.id||null,e.url.includes("exist.ru")?e.url.includes("/Price/")||e.url.includes("/Catalog/Goods/")?(c("–°—Ç—Ä–∞–Ω–∏—Ü–∞ exist.ru –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å¬ª","success"),void(i("btn-select").disabled=!1)):(c("–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤ (/Price/ –∏–ª–∏ /Catalog/Goods/)","warning"),void(i("btn-select").disabled=!0)):(c("–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ exist.ru –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤","warning"),void(i("btn-select").disabled=!0))):(c("–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É exist.ru —Å —Ç–æ–≤–∞—Ä–∞–º–∏","warning"),void(i("btn-select").disabled=!0))}async function m(){if(n){c("–°—á–∏—Ç—ã–≤–∞—é —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤...","info"),i("btn-select").disabled=!0;try{const t=await chrome.tabs.sendMessage(n,{type:"GET_PRODUCTS"});if(!t||!t.products)return c("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã","error"),void(i("btn-select").disabled=!1);if(e=t.products,t.debug&&console.log("[ProductAnalyzer] DOM debug:\n"+t.debug),0===e.length){const e=t.debug?`\n\nDebug: ${t.debug}`:"";return c("–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞","warning"),console.warn("[ProductAnalyzer] No products found."+e),void(i("btn-select").disabled=!1)}const s=e.filter(e=>e.price>0).length;if(0===s)return c("–ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –Ω–æ –Ω–∏ —É –æ–¥–Ω–æ–≥–æ –Ω–µ—Ç —Ü–µ–Ω—ã. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã","warning"),void(i("btn-select").disabled=!1);c(`–ù–∞–π–¥–µ–Ω–æ ${s} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å —Ü–µ–Ω–æ–π. –ù–∞–∂–º–∏—Ç–µ ¬´–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª`,"success"),i("btn-analyze").disabled=!1,i("products-count").textContent=`${s} –ø—Ä–µ–¥–ª.`,i("products-preview").style.display="block";const r=i("preview-list");r.innerHTML=e.slice(0,3).map(e=>`<div class="preview-item">\n            <span class="preview-brand">${d(e.manufacturer||e.supplier||"‚Äî")}</span>\n            <span class="preview-price">${e.price>0?e.price.toLocaleString("ru-RU")+" ‚ÇΩ":"‚Äî"}</span>\n          </div>`).join(""),e.length>3&&(r.innerHTML+=`<div class="preview-more">...–∏ –µ—â—ë ${e.length-3}</div>`)}catch(e){console.error("[ProductAnalyzer] Error getting products:",e),c("–û—à–∏–±–∫–∞: –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É exist.ru –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ ‚Äî –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ","error"),i("btn-select").disabled=!1}}}async function p(){const n=await s();if(!n)return o("settings"),void(i("settings-hint").textContent="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á HuggingFace –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è");if(0!==e.length){o("loading"),i("loading-count").textContent=`–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é ${e.length} —Ç–æ–≤–∞—Ä–æ–≤...`;try{const s=await chrome.runtime.sendMessage({type:"ANALYZE_PRODUCTS",products:e,apiKey:n});if(!s.success)return o("error"),void(i("error-message").textContent=s.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");const c=s.data;t=c;const[m]=await chrome.tabs.query({active:!0,currentWindow:!0});await(r=c,a=e,d=m?.url||"",u=m?.title||"–ê–Ω–∞–ª–∏–∑ exist.ru",new Promise(e=>{chrome.storage.local.get(["analysisHistory"],n=>{const t=n.analysisHistory||[],i={id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),url:d,pageTitle:u,result:r,products:a};t.unshift(i);const s=t.slice(0,50);chrome.storage.local.set({lastAnalysis:{timestamp:Date.now(),url:d,result:r,products:a},analysisHistory:s},e)})})),l(c),o("results")}catch(e){o("error"),i("error-message").textContent=e.message||"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ"}var r,a,d,u}else c("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã","warning")}document.addEventListener("DOMContentLoaded",async()=>{i("btn-select").addEventListener("click",m),i("btn-analyze").addEventListener("click",p),i("btn-history").addEventListener("click",a),i("btn-settings").addEventListener("click",async()=>{const e=await s();i("api-key-input").value=e,o("settings")}),i("btn-save-key").addEventListener("click",async()=>{const e=i("api-key-input").value.trim();e?(await function(e){return new Promise(n=>{chrome.storage.local.set({apiKey:e},n)})}(e),i("settings-hint").textContent="API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω",o("main"),await u()):i("settings-hint").textContent="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á"}),i("btn-back-settings").addEventListener("click",()=>{o("main"),u()}),i("btn-back-history").addEventListener("click",()=>{o("main"),u()}),i("btn-clear-history").addEventListener("click",async()=>{confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∞–Ω–∞–ª–∏–∑–æ–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")&&(await new Promise(e=>{chrome.storage.local.set({analysisHistory:[],lastAnalysis:null},e)}),await a())}),i("btn-back-results").addEventListener("click",()=>{o("main"),u()}),i("btn-export").addEventListener("click",r),i("btn-retry").addEventListener("click",()=>{o("main"),u()});const n=await new Promise(e=>{chrome.storage.local.get(["lastAnalysis"],n=>{e(n.lastAnalysis||null)})}),[c]=await chrome.tabs.query({active:!0,currentWindow:!0});if(n&&c?.url===n.url)return t=n.result,e=n.products,l(n.result),void o("results");o("main"),await u()})})();