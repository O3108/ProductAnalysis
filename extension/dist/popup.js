(()=>{"use strict";let e=[],n=null;const t=e=>document.getElementById(e);function s(){return new Promise(e=>{chrome.storage.local.get(["apiKey"],n=>{e(n.apiKey||"")})})}function r(e){["screen-main","screen-settings","screen-results","screen-loading","screen-error"].forEach(e=>{const n=document.getElementById(e);n&&(n.style.display="none")});const n=document.getElementById(`screen-${e}`);n&&(n.style.display="flex")}function i(e,n="info"){const s=t("status-text");s.textContent=e,s.className=`status-text status-${n}`}function a(e){return(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}async function c(){const e=await async function(){return new Promise(e=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>{e(n[0]||null)})})}();return e&&e.url?(n=e.id||null,e.url.includes("exist.ru")?e.url.includes("/Price/")?(i("–°—Ç—Ä–∞–Ω–∏—Ü–∞ exist.ru –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å¬ª","success"),void(t("btn-select").disabled=!1)):(i("–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤ (/Price/)","warning"),void(t("btn-select").disabled=!0)):(i("–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ exist.ru –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤","warning"),void(t("btn-select").disabled=!0))):(i("–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É exist.ru —Å —Ç–æ–≤–∞—Ä–∞–º–∏","warning"),void(t("btn-select").disabled=!0))}async function d(){if(n){i("–°—á–∏—Ç—ã–≤–∞—é —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤...","info"),t("btn-select").disabled=!0;try{const s=await chrome.tabs.sendMessage(n,{type:"GET_PRODUCTS"});if(!s||!s.products)return i("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã","error"),void(t("btn-select").disabled=!1);if(e=s.products,s.debug&&console.log("[ProductAnalyzer] DOM debug:\n"+s.debug),0===e.length){const e=s.debug?`\n\nDebug: ${s.debug}`:"";return i("–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞","warning"),console.warn("[ProductAnalyzer] No products found."+e),void(t("btn-select").disabled=!1)}const r=e.filter(e=>e.price>0).length;i(`–ù–∞–π–¥–µ–Ω–æ ${e.length} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (${r} —Å —Ü–µ–Ω–æ–π). –ù–∞–∂–º–∏—Ç–µ ¬´–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª`,"success"),t("btn-analyze").disabled=!1,t("products-count").textContent=`${e.length} –ø—Ä–µ–¥–ª.`,t("products-preview").style.display="block";const c=t("preview-list");c.innerHTML=e.slice(0,3).map(e=>`<div class="preview-item">\n            <span class="preview-brand">${a(e.manufacturer||e.supplier||"‚Äî")}</span>\n            <span class="preview-price">${e.price>0?e.price.toLocaleString("ru-RU")+" ‚ÇΩ":"‚Äî"}</span>\n          </div>`).join(""),e.length>3&&(c.innerHTML+=`<div class="preview-more">...–∏ –µ—â—ë ${e.length-3}</div>`)}catch(e){i("–û—à–∏–±–∫–∞: –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É exist.ru –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞","error"),t("btn-select").disabled=!1}}}async function l(){const n=await s();if(!n)return r("settings"),void(t("settings-hint").textContent="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á HuggingFace –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è");if(0!==e.length){r("loading"),t("loading-count").textContent=`–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é ${e.length} —Ç–æ–≤–∞—Ä–æ–≤...`;try{const s=await chrome.runtime.sendMessage({type:"ANALYZE_PRODUCTS",products:e,apiKey:n});if(!s.success)return r("error"),void(t("error-message").textContent=s.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");!function(e){const n=t("results-list");n.innerHTML="",t("results-summary").innerHTML=`\n    <div class="summary-box">\n      <div class="summary-label">–õ—É—á—à–∏–π –≤—ã–±–æ—Ä</div>\n      <div class="summary-best">${a(e.bestChoice)}</div>\n      <div class="summary-text">${a(e.summary)}</div>\n    </div>\n  `,e.results.forEach(e=>{const t=document.createElement("div");t.className=`product-card rank-${e.rank<=3?e.rank:"other"}`;const s=e.score>=8?"#22c55e":e.score>=6?"#f59e0b":"#ef4444",r=1===e.rank?"ü•á":2===e.rank?"ü•à":3===e.rank?"ü•â":`#${e.rank}`,i=e.pros.map(e=>`<li class="pro">‚úì ${a(e)}</li>`).join(""),c=e.cons.map(e=>`<li class="con">‚úó ${a(e)}</li>`).join("");t.innerHTML=`\n      <div class="card-header">\n        <div class="card-rank">${r}</div>\n        <div class="card-info">\n          <div class="card-brand">${a(e.brand||e.name)}</div>\n          <div class="card-price">${e.price>0?e.price.toLocaleString("ru-RU")+" ‚ÇΩ":"–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}</div>\n        </div>\n        <div class="card-score" style="color: ${s}">\n          <span class="score-value">${e.score.toFixed(1)}</span>\n          <span class="score-label">/10</span>\n        </div>\n      </div>\n      <div class="card-verdict">${a(e.verdict)}</div>\n      <ul class="card-list">\n        ${i}\n        ${c}\n      </ul>\n      <div class="card-recommendation">${a(e.recommendation)}</div>\n    `,n.appendChild(t)})}(s.data),r("results")}catch(e){r("error"),t("error-message").textContent=e.message||"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ"}}else i("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã","warning")}document.addEventListener("DOMContentLoaded",async()=>{r("main"),await c(),t("btn-select").addEventListener("click",d),t("btn-analyze").addEventListener("click",l),t("btn-settings").addEventListener("click",async()=>{const e=await s();t("api-key-input").value=e,r("settings")}),t("btn-save-key").addEventListener("click",async()=>{const e=t("api-key-input").value.trim();e?(await function(e){return new Promise(n=>{chrome.storage.local.set({apiKey:e},n)})}(e),r("main"),await c()):t("settings-hint").textContent="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á"}),t("btn-back-settings").addEventListener("click",()=>r("main")),t("btn-back-results").addEventListener("click",()=>r("main")),t("btn-retry").addEventListener("click",()=>{r("main")})})})();